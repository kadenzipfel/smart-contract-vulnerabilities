<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Hash Collision when using abi.encodePacked() with Multiple Variable-Length Arguments</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="hash-collision-when-using-abiencodepacked-with-multiple-variable-length-arguments"><a class="header" href="#hash-collision-when-using-abiencodepacked-with-multiple-variable-length-arguments">Hash Collision when using <code>abi.encodePacked()</code> with Multiple Variable-Length Arguments</a></h1>
<p>In Solidity, the <code>abi.encodePacked()</code> function is used to create tightly packed byte arrays which can then be hashed using <code>keccak256()</code></p>
<p>However, this function can be dangerous when used with multiple variable-length arguments because it can lead to hash collisions. These collisions can potentially be exploited in scenarios such as signature verification, allowing attackers to bypass authorization mechanisms.</p>
<p><strong>Hash Collision</strong> is a situation where two different sets of inputs produce the same hash output. In this context, a hash collision can occur when using <code>abi.encodePacked()</code> with multiple variable-length arguments, allowing an attacker to craft different inputs that produce the same hash.</p>
<h2 id="understanding-the-vulnerability"><a class="header" href="#understanding-the-vulnerability">Understanding the vulnerability</a></h2>
<p>When <code>abi.encodePacked()</code> is used with multiple variable-length arguments (such as arrays and strings), the packed encoding does not include information about the boundaries between different arguments. This can lead to situations where different combinations of arguments result in the same encoded output, causing hash collisions.</p>
<p>For example, consider the following two calls to <code>abi.encodePacked()</code>:</p>
<pre><code class="language-solidity">abi.encodePacked(["a", "b"], ["c", "d"])
</code></pre>
<pre><code class="language-solidity">abi.encodePacked(["a"], ["b", "c", "d"])
</code></pre>
<p>Both calls could potentially produce the same packed encoding because <code>abi.encodePacked()</code> simply concatenates the elements without any delimiters!</p>
<p>Consider the below example for strings:</p>
<pre><code class="language-solidity">abi.encodePacked("foo", "bar") == abi.encodePacked("fo", "obar")
</code></pre>
<p>Strings in Solidity are dynamic types and when they are concatenated using <code>abi.encodePacked()</code>, there is no delimiter between them to mark their boundaries, which can lead to hash collisions.</p>
<p>As a matter of fact, the below warning is taken as it is straight from the <a href="https://docs.soliditylang.org/en/latest/abi-spec.html#non-standard-packed-mode">official solidity language documentation</a> regarding the same.</p>
<blockquote>
<p>[!WARNING]
If you use <code>keccak256(abi.encodePacked(a, b))</code> and both <code>a</code> and <code>b</code> are dynamic types, it is easy to craft collisions in the hash value by moving parts of <code>a</code> into <code>b</code> and vice-versa.
More specifically, <code>abi.encodePacked("a", "bc") == abi.encodePacked("ab", "c")</code>. If you use <code>abi.encodePacked</code> for signatures, authentication or data integrity, make sure to always use the same types and check that at most one of them is dynamic. Unless there is a compelling reason, <code>abi.encode</code> should be preferred.</p>
</blockquote>
<h2 id="sample-code-analysis"><a class="header" href="#sample-code-analysis">Sample Code Analysis</a></h2>
<pre><code class="language-solidity">/// INSECURE
function addUsers(address[] calldata admins, address[] calldata regularUsers, bytes calldata signature) external {
    if (!isAdmin[msg.sender]) {
        bytes32 hash = keccak256(abi.encodePacked(admins, regularUsers));
        address signer = hash.toEthSignedMessageHash().recover(signature);
        require(isAdmin[signer], "Only admins can add users.");
    }
    for (uint256 i = 0; i &lt; admins.length; i++) {
        isAdmin[admins[i]] = true;
    }
    for (uint256 i = 0; i &lt; regularUsers.length; i++) {
        isRegularUser[regularUsers[i]] = true;
    }
}
</code></pre>
<p>In the provided sample code above, the <code>addUsers</code> function uses <code>abi.encodePacked(admins, regularUsers)</code> to generate a hash. An attacker could exploit this by rearranging elements between the <code>admins</code> and <code>regularUsers</code> arrays, resulting in the same hash and thereby bypassing authorization checks.</p>
<pre><code class="language-solidity">/// INSECURE
function verifyMessage(string calldata message1, string calldata message2, bytes calldata signature) external {
    bytes32 hash = keccak256(abi.encodePacked(message1, message2));
    address signer = hash.toEthSignedMessageHash().recover(signature);
    require(isAuthorized[signer], "Unauthorized signer");
}
</code></pre>
<p>The above function <code>verifyMessage()</code> could easily be exploited as below:-</p>
<pre><code class="language-solidity">verifyMessage("hello", "world", signature);
</code></pre>
<p>or</p>
<pre><code class="language-solidity">verifyMessage("hell", "oworld", signature);
</code></pre>
<p>or a variation of the string <code>hello</code> <code>world</code></p>
<p>All variations of the string <code>hello</code> <code>world</code> passed to <code>verifyMessage()</code> would produce the same hash, potentially allowing an attacker to bypass the authorization check if they can provide a valid signature for their manipulated inputs.</p>
<p><strong>Fixed Code Using Single User:</strong></p>
<pre><code class="language-solidity">function addUser(address user, bool admin, bytes calldata signature) external {
    if (!isAdmin[msg.sender]) {
        bytes32 hash = keccak256(abi.encodePacked(user));
        address signer = hash.toEthSignedMessageHash().recover(signature);
        require(isAdmin[signer], "Only admins can add users.");
    }
    if (admin) {
        isAdmin[user] = true;
    } else {
        isRegularUser[user] = true;
    }
}
</code></pre>
<p>This approach eliminates the use of variable-length arrays, thus avoiding the hash collision issue entirely by dealing with a single user at a time.</p>
<p><strong>Fixed Code Using Fixed-Length Arrays:</strong></p>
<pre><code class="language-solidity">function addUsers(address[3] calldata admins, address[3] calldata regularUsers, bytes calldata signature) external {
    if (!isAdmin[msg.sender]) {
        bytes32 hash = keccak256(abi.encodePacked(admins, regularUsers));
        address signer = hash.toEthSignedMessageHash().recover(signature);
        require(isAdmin[signer], "Only admins can add users.");
    }
    for (uint256 i = 0; i &lt; admins.length; i++) {
        isAdmin[admins[i]] = true;
    }
    for (uint256 i = 0; i &lt; regularUsers.length; i++) {
        isRegularUser[regularUsers[i]] = true;
    }
}
</code></pre>
<p>In this version, fixed-length arrays are used, which mitigates the risk of hash collisions since the encoding is unambiguous.</p>
<h2 id="remediation-strategies"><a class="header" href="#remediation-strategies">Remediation Strategies</a></h2>
<p>To prevent this type of hash collision, the below remediation strategies can be employed:</p>
<ol>
<li>
<p><strong>Avoid Variable-Length Arguments</strong>: Avoid using <code>abi.encodePacked()</code> with variable-length arguments such as arrays and strings. Instead, use fixed-length arrays to ensure the encoding is unique and unambiguous.</p>
</li>
<li>
<p><strong>Use <code>abi.encode()</code> Instead</strong>: Unlike <code>abi.encodePacked()</code>, <code>abi.encode()</code> includes additional type information and length prefixes in the encoding, making it much less prone to hash collisions. Switching from <code>abi.encodePacked()</code> to <code>abi.encode()</code> is a simple yet effective fix.</p>
</li>
</ol>
<blockquote>
<p>[!IMPORTANT]
Replay Protection does not protect against possible hash collisions!</p>
<p>It is listed here as a defense in depth strategy and SHOULD NOT be solely relied upon to protect against said vulnerability</p>
</blockquote>
<ol start="3">
<li><strong>Replay Protection</strong>: Implement replay protection mechanisms to prevent attackers from reusing valid signatures. This can involve including nonces or timestamps in the signed data. However, this does not completely eliminate the risk of hash collisions but adds an additional layer of security. More on this can be found <a href="./missing-protection-signature-replay.html">here</a></li>
</ol>
<h2 id="sources"><a class="header" href="#sources">Sources</a></h2>
<ul>
<li><a href="https://swcregistry.io/docs/SWC-133/">Smart Contract Weakness Classification #133</a></li>
<li><a href="https://docs.soliditylang.org/en/latest/abi-spec.html#non-standard-packed-mode">Solidity Non-standard Packed Mode</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../vulnerabilities/weak-sources-randomness.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../vulnerabilities/timestamp-dependence.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../vulnerabilities/weak-sources-randomness.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../vulnerabilities/timestamp-dependence.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
